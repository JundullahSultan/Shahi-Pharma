<%- include('partials/admin-header', { title: t.adminUsers.title, page: 'users' }) %>
    <div class="toolbar">
        <div class="search-bar">
            <i class="ph ph-magnifying-glass"></i>
            <input type="text" id="searchInput" placeholder="<%= t.adminUsers.searchPlaceholder %>">
        </div>
        <button class="btn-primary" style="width: auto; margin:0;" onclick="openCreateModal()"><%= t.adminUsers.addNew %></button>
    </div>

    <section class="card">
        <table>
            <thead>
                <tr>
                    <th><%= t.common.name %></th>
                    <th><%= t.auth.pharmacyName %></th>
                    <th><%= t.common.email %></th>
                    <th><%= t.common.role %></th>
                    <th><%= t.adminUsers.joined %></th>
                    <th><%= t.common.actions %></th>
                </tr>
            </thead>
            <tbody>
                <% users.forEach(user => { %>
                <tr id="row-<%= user._id %>">
                    <td>
                        <div class="user-info">
                            <div class="avatar-sm">
                                <% if(user.imageURL) { %>
                                    <img src="<%= user.imageURL %>" alt="<%= user.name %>" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">
                                <% } else { %>
                                    <%= user.name[0] %>
                                <% } %>
                            </div>
                            <span><%= user.name %></span>
                        </div>
                    </td>
                    <td><%= user.pharmacy %></td>
                    <td><%= user.email %></td>
                    <td>
                        <span class="badge <%= user.role === 'admin' ? 'approved' : 'pending' %>">
                            <%= user.role %>
                        </span>
                    </td>
                    <td><%= user.joined %></td>
                    <td>
                        <div class="actions">
                            <button class="btn-icon cancel" title="<%= t.common.delete %>" onclick="deleteUser('<%= user._id%>')"><i class="ph ph-trash"></i></button>
                        </div>
                    </td>
                </tr>
                <% }) %>
            </tbody>
        </table>
    </section>

    <dialog id="createUserModal" style="border: none; border-radius: 12px; padding: 0; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 100%; max-width: 500px; background: var(--surface);">
        <div style="padding: 20px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0;"><%= t.adminUsers.addNew %></h3>
            <button class="btn-icon" onclick="closeCreateModal()"><i class="ph ph-x"></i></button>
        </div>

        <form id="createUserForm" enctype="multipart/form-data" style="padding: 20px; display: flex; flex-direction: column; gap: 15px;">
            <div class="form-group">
                <label style="display: block; margin-bottom: 5px;"><%= t.common.name %></label>
                <input type="text" name="name" required style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--glass-border); background: var(--surface-light); color: var(--text-main);">
            </div>
            <div class="form-group">
                <label style="display: block; margin-bottom: 5px;"><%= t.auth.pharmacyName %></label>
                <input type="text" name="pharmacy" required style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--glass-border); background: var(--surface-light); color: var(--text-main);">
            </div>
            <div class="form-group">
                <label style="display: block; margin-bottom: 5px;"><%= t.common.email %></label>
                <input type="email" name="email" required style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--glass-border); background: var(--surface-light); color: var(--text-main);">
            </div>
            <div class="form-group">
                <label style="display: block; margin-bottom: 5px;"><%= t.auth.password %></label>
                <input type="password" name="password" required style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--glass-border); background: var(--surface-light); color: var(--text-main);">
            </div>
            <div class="form-group">
                <label style="display: block; margin-bottom: 5px;"><%= t.common.role %></label>
                <select name="role" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--glass-border); background: var(--surface-light); color: var(--text-main);">
                    <option value="user">User</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            
            <div class="form-group">
                <label style="display: block; margin-bottom: 5px;">Profile Photo</label>
                <input type="file" name="imageURL" accept="image/*" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--glass-border); background: var(--surface-light); color: var(--text-main);">
            </div>

            <button type="submit" class="btn-primary" style="margin-top: 10px;">Create User</button>
        </form>
    </dialog>

    <script>
        const modal = document.getElementById('createUserModal');
        
        function openCreateModal() {
            modal.showModal();
        }
        
        function closeCreateModal() {
            modal.close();
        }

        // Handle Form Submit with File Upload
        document.getElementById('createUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // FormData automatically captures file inputs
            const formData = new FormData(this);
            
            try {
                const response = await fetch('/admin/users', {
                    method: 'POST',
                    body: formData // Send as FormData (not JSON)
                });
                const result = await response.json();
                
                if (response.ok) {
                    window.location.reload(); // Reload to show new user
                } else {
                    alert('Error: ' + (result.message || 'Failed to create user'));
                }
            } catch (err) {
                console.error(err);
                alert('An error occurred.');
            }
        });
    </script>

<%- include('partials/admin-footer', { page: 'users' }) %>