<%- include('partials/admin-header', { title: t.adminOrders.title, page: 'orders' }) %>

            <div class="filter-tabs">
                <button class="filter-btn active"><%= t.adminOrders.filterAll %></button>
                <button class="filter-btn"><%= t.adminDashboard.pending %></button>
                <button class="filter-btn"><%= t.adminDashboard.approved %></button>
                <button class="filter-btn"><%= t.adminDashboard.cancelled %></button>
         
            </div>

            <section class="card">
                <table>
                    <thead>
                        <tr>
                        
                            <th><%= t.userRequest.medName %></th>
                            <th><%= t.common.pharmacy %></th>
                            <th><%= t.common.items %></th>
                            <th><%= t.common.totalAmount %></th>
          
                            <th><%= t.common.date %></th>
                            <th><%= t.common.status %></th>
                            <th><%= t.common.actions %></th>
                        </tr>
  
                   </thead>
                    <tbody>
                        <% if (orders && orders.length > 0) { %>
                            <% orders.forEach(order => { %>
                            <tr>
                                <td><strong><%= order.medicineId ? order.medicineId.name : t.adminOrders.deletedMedicine %></strong></td>
                                
                                <td><%= order.user?.name || t.adminOrders.unknownUser %></td>
                                
                                <td><%= order.quantity %> <%= t.common.items %></td>
                                
 
                                <td>$<%= order.price ? order.totalPrice : '0.00' %></td>

                                <% const orderDate = new Date(order.createdAt).toLocaleDateString('en-US') %>
                                
                           
                                <td><%= orderDate %></td>
                                
                                <td><span class="badge <%= order.status.toLowerCase() %>"><%= order.status %></span></td>
                       
                                         
                                <td>
                                    
                                    <% if(order.status === 'Pending' || order.status === 'pending') { %>
              
                                        <div class="actions" id="actions-<%= order._id %>">
                                            <button class="btn-icon approve status-btn" 
                      
                                                    title="<%= t.adminDashboard.approved %>" 
                                                    data-id="<%= order._id %>" 
              
                                                    data-status="approved">
                                                <i class="ph ph-check"></i>
            
                                            </button>
                                            
                        
                                            <button class="btn-icon cancel status-btn" 
                                                    title="<%= t.common.cancel %>" 
                       
                                                    data-id="<%= order._id %>" 
                                                    data-status="cancelled">
                
                                                <i class="ph ph-x"></i>
                                            </button>
                      
                                        </div>
                                    <% } else { %>
                                        <div class="actions">
                                            <button class="btn-icon delete-btn delete-order-btn" data-id="<%= order._id %>" title="Delete Order">
                                                <i class="ph ph-trash"></i>
                                            </button>
                                        </div>
                                    <% } %>
                                </td>
                            </tr>
  
                            <% }) %>
                        <% } else { %>
                            <tr><td colspan="7"><%= t.adminOrders.noOrders %></td></tr>
             
                        <% } %>
                    </tbody>
                </table>
            </section>
            <div id="toast-container"></div>

<div id="confirmModal" class="custom-backdrop">
    <div class="modal-content confirmation-box">
        <div class="icon-box danger large">
            <i class="ph ph-trash"></i>
        </div>
        <h3><%= t.common.delete %>?</h3>
        <p><%= t.adminOrders.deleteConfirmMessage || "Are you sure you want to delete this order? This action cannot be undone." %></p>
        
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeModal()"><%= t.common.cancel %></button>
            <button class="btn-delete" id="confirmDeleteBtn"><%= t.common.delete %></button>
        </div>
    </div>
</div>

<script>
    // --- CRITICAL FIX: Move Modal to Body ---
    // This ensures the modal is not affected by parent styles (perspective/transform)
    document.addEventListener("DOMContentLoaded", () => {
        const modal = document.getElementById('confirmModal');
        const toastContainer = document.getElementById('toast-container');
        if(modal) document.body.appendChild(modal);
        if(toastContainer) document.body.appendChild(toastContainer);
    });

    // --- Toast Logic ---
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        const icon = type === 'success' ? '<i class="ph ph-check-circle"></i>' : '<i class="ph ph-warning-circle"></i>';
        
        toast.className = `toast ${type}`; 
        toast.innerHTML = `${icon} <span>${message}</span>`;
        container.appendChild(toast);

        // Remove after 3 seconds
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateY(-20px)';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // --- Modal Logic ---
    const modal = document.getElementById('confirmModal');
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    let orderIdToDelete = null;

    function openDeleteModal(id) {
        orderIdToDelete = id;
        modal.classList.add('active');
    }

    function closeModal() {
        orderIdToDelete = null;
        modal.classList.remove('active');
    }

    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });

    document.querySelectorAll('.delete-order-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            openDeleteModal(btn.dataset.id);
        });
    });

    confirmBtn.addEventListener('click', async () => {
        if (!orderIdToDelete) return;

        const originalText = confirmBtn.innerText;
        confirmBtn.innerText = '...';
        confirmBtn.disabled = true;

        try {
            const res = await fetch(`/admin/orders/${orderIdToDelete}`, { method: 'DELETE' });
            
            if (res.ok) {
                const row = document.getElementById(`order-row-${orderIdToDelete}`);
                if(row) {
                    row.style.opacity = '0';
                    setTimeout(() => row.remove(), 300);
                } else {
                     location.reload();
                }
                showToast('Order deleted successfully', 'success');
            } else {
                showToast('Failed to delete order', 'error');
            }
        } catch (err) {
            console.error(err);
            showToast('Network Error', 'error');
        } finally {
            closeModal();
            confirmBtn.innerText = originalText;
            confirmBtn.disabled = false;
        }
    });
</script>
        <%- include('partials/admin-footer', { page: 'orders' }) %>