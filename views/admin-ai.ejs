<%- include('partials/admin-header') %>

<section class="card" style="height: 80vh; display: flex; flex-direction: column;">
    <div class="card-header">
        <h2><i class="ph ph-sparkle" style="color: var(--primary);"></i> <%= t.aiAnalyst.title %></h2>
    </div>

    <div id="chatBox" style="flex: 1; overflow-y: auto; padding: 20px; background: rgba(0,0,0,0.2); border-radius: 12px; margin-bottom: 20px; display: flex; flex-direction: column; gap: 15px;">
        <div class="message bot">
            <div class="bubble">
                <%= t.aiAnalyst.welcome %>
                <br>• "<%= t.aiAnalyst.q1 %>"
                <br>• "<%= t.aiAnalyst.q2 %>"
                <br>• "<%= t.aiAnalyst.q3 %>"
            </div>
        </div>
    </div>

    <form id="aiForm" style="display: flex; flex-direction: column; gap: 10px;">
        <input type="text" id="userQuestion" placeholder="<%= t.aiAnalyst.placeholder %>" required 
               style="flex: 1; padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border); background: var(--bg-dark); color: var(--text-main);">
        <button type="submit" class="btn-primary" style="padding: 15px 25px;">
           Send <i class="ph ph-paper-plane-right"></i>
        </button>
    </form>
</section>

<style>
    /* ... keep your existing styles ... */
    .message { display: flex; width: 100%; }
    .message.user { justify-content: flex-end; }
    .message.bot { justify-content: flex-start; }
    
    .bubble {
        max-width: 75%;
        padding: 12px 18px;
        border-radius: 12px;
        line-height: 1.5;
        font-size: 0.95rem;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .message.user .bubble {
        background: var(--primary);
        color: white;
        border-bottom-right-radius: 2px;
    }
    
    .message.bot .bubble {
        background: var(--surface-light);
        color: var(--text-main);
        border: 1px solid var(--glass-border);
        border-bottom-left-radius: 2px;
    }
</style>

<script>
    const chatBox = document.getElementById('chatBox');
    const form = document.getElementById('aiForm');
    const input = document.getElementById('userQuestion');

    // Add translation variables for JS to use
    const TXT_THINKING = "<%= t.aiAnalyst.thinking %>";
    const TXT_ERROR_CONNECT = "<%= t.aiAnalyst.error %>";
    const TXT_ERROR_NO_RES = "<%= t.aiAnalyst.noResponse %>";

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = input.value;
        if(!text) return;

        addMessage(text, 'user');
        input.value = '';
        
        const loadingId = addMessage(TXT_THINKING, 'bot');

        try {
            const res = await fetch('/admin/ai/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text }) 
            });

            const data = await res.json();
            const botBubble = document.getElementById(loadingId);
            
            if (data.response) {
                botBubble.innerText = data.response;
            } else {
                botBubble.innerText = TXT_ERROR_NO_RES;
            }

        } catch (err) {
            document.getElementById(loadingId).innerText = TXT_ERROR_CONNECT;
            console.error(err);
        }
    });

    function addMessage(text, sender) {
        const div = document.createElement('div');
        div.className = `message ${sender}`;
        const id = 'msg-' + Date.now();
        div.innerHTML = `<div class="bubble" id="${id}">${text}</div>`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
        return id;
    }
</script>

<%- include('partials/admin-footer', { page: 'ai' }) %>