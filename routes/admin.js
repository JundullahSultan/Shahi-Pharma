const express = require('express');
const router = express.Router();
const adminController = require('../controllers/admin.js');
const authentication = require('../middleware/auth.js');
const aiController = require('../controllers/ai');

// ==========================================
// 1. PUBLIC ROUTES (No Login Required)
// ==========================================

// Login Page & Logic
router.get('/login', adminController.login);
router.post('/login', adminController.loginAdmin);

// Logout
router.get('/logout', adminController.logoutAdmin);

// ==========================================
// 2. PROTECTED MIDDLEWARE BARRIER
// ==========================================
// Any route defined BELOW this line requires the user to be a logged-in Admin.
// This saves you from writing 'authentication.verifyAdmin' on every single line.

// ==========================================
// 3. DASHBOARD & ORDERS
// ==========================================
router.get(
  '/dashboard',
  authentication.verifyAdmin,
  adminController.sendDashboard,
);
router.get(
  '/orders',
  authentication.verifyAdmin,
  adminController.sendOrdersPage,
);
router.put(
  '/orders/:id/status',
  authentication.verifyAdmin,
  adminController.updateOrderStatus,
);

// ==========================================
// 4. USER MANAGEMENT
// ==========================================
router.get('/users', authentication.verifyAdmin, adminController.sendUsersPage);
router.post('/users', authentication.verifyAdmin, adminController.createUser);
router.delete(
  '/users/:id',
  authentication.verifyAdmin,
  adminController.deleteUser,
);

// ==========================================
// 5. MEDICINE MANAGEMENT
// ==========================================

// View Medicine Inventory
router.get(
  '/medicines',
  authentication.verifyAdmin,
  adminController.sendMedicinesPage,
);

// Create New Medicine (Handles Image Upload)
router.post(
  '/medicines',
  authentication.verifyAdmin,
  adminController.uploadImage,
  adminController.createMedicine,
);

// Update Existing Medicine (Handles Image Upload)
// Fix: Added uploadImage middleware so we can update the photo too
router.put(
  '/medicines/:id',
  authentication.verifyAdmin,
  adminController.uploadImage,
  adminController.updateMedicine,
);

// Delete Medicine
// Fix: Now protected by the middleware barrier above
router.delete(
  '/medicines/:id',
  authentication.verifyAdmin,
  adminController.deleteMedicine,
);

// Add these lines:
router.get(
  '/requests',
  authentication.verifyAdmin,
  adminController.getRequests,
);
router.put(
  '/requests/:id/status',
  authentication.verifyAdmin,
  adminController.updateRequestStatus,
);

router.get('/ai', authentication.verifyAdmin, aiController.getAiPage);
router.post('/ai/chat', authentication.verifyAdmin, aiController.chatWithData);

module.exports = router;
